= CDP Public Cloud: Hands On Labs Infrastructure Provisioner
:toc:

Author: **Kuldeep Sahu**

Email: **ksahu@cloudera.com**

Author: **Avanish Tiwari**

Email: **aktiwari@cloudera.com**



---





image::images/keycloak_login.png[kycloak_login,600,400]

== Overview

Hands-on Labs play a crucial role in showcasing the capabilities of Cloudera Data Platform Public Cloud form factor to partners and customers. They offer a practical and immersive learning experience that goes beyond mere overview. Hands-on Labs facilitate participant engagement and allow them to explore and interact with different PaaS offerings of Cloudera Data Platform.


Infrastructure components are important and play a vital role in acheieving the goal of Hands-on Labs and to give a better experience to the participants.

**Hands On Labs Infrastructure Provisioner** is a container based solution which takes care of provisioning the required infrastaructure components without much manual efforts. By executing a single command it creates a **disposable** on-demand stack consists of:

1. CDP Environment
2. Datalake
3. Data Service (Currently CDW & CDE)
4. Keycloak Server
5. Users 


== Technology Stack
**Hands On Labs Infrastructure Provisioner** employs a robust toolchain consisting of:


1.  Ansible
2.  Terraform
3.  Cloudera.cloud
4.  CDP-tf-quickstarts
5.  CDPY
6.  CDP CLI
7.  AWS CLI
8.  Shell Scripting

All the above tools are integrated with each other and packaged as a Dokcer Container for use.

---
== How to install docker on your local machine
Follow below page for installing docker on your machine.

https://docs.docker.com/engine/install/

---

== How To Create Docker Image for HoL-Automation

=== Step 1: Clone the code and cd into the hol_automation/build directory

[.shell]
----

cd hol_automation/build

----

---

=== Step 2: Build the docker image

[.shell]
----

# docker build . -t <reponame>/<imagename>:<tagname>
docker build . -t hol:latest

----
To verify the Docker image is actually created, by image ID or Name:
[.shell]
----

docker images

----

---

=== Step 3: Login to Docker Hub
The docker image is available at Docker Hub. Once the Docker is installed and ready to use pull the **cdp-public-cloud-hol-provisioner:latest** image by executing below command.


[.shell]
----

ksahu@Kuldeeps-MacBook-Air build % docker login             
Log in with your Docker ID or email address to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com/ to create one.
You can log in with your password or a Personal Access Token (PAT). Using a limited-scope PAT grants better security and is required for organizations using SSO. Learn more at https://docs.docker.com/go/access-tokens/

Username: clouderapartners
Password: 
Login Succeeded
ksahu@Kuldeeps-MacBook-Air build % 

----

---

=== Step 4: Tag and Push the Docker Image
The Docker image will be available at Docker Hub. Once the Docker is installed, and you are logged in to Docker Hub, push the **cdp-public-cloud-hol-provisioner:latest** image by executing below command.


[.shell]
----

docker tag hol:latest clouderapartners/cdp-public-cloud-hol-provisioner:latest
docker push clouderapartners/cdp-public-cloud-hol-provisioner:latest

----


== Major features implemented in the CDP **Hands On Labs (HoL) Infrastructure Provisioner** Automation for AWS:


1.  Ubuntu Linux based base image.

2.  Optional Provisioning of KeyCloak Server for providing the external user access to Lab Environment with the help of SSO.

3.  When Keycloak Server is Provisioned using this Automation, workshop owner can create required number of workshop users with  Keycloak (SSO) based access to workshop environment (depending on type of workshop e.g. CML, CDW or CDE).

4.  Provisioned Keycloak users are added in the backend to IAM Groups in the CDP Tenant with the least required access Roles.

5.  Assignment of required roles for workshop user access while deploying data services (Removed manual intervention).

6.  Externalise (parameterization from configfile) the Keycloak Admin Password. (for improved security control)

7.  Added below Validation Prerequisite checks for AWS and CDP Infrastructures:
    -  Input Configfile is present.
    -  Required input parameter keys are present in configfile with non-empty values.
    -  Enough quotas for VPC, ElasticIP and S3 bucket creation is available on AWS.
    -  Enough quotas for CDP IAM Users, IAM Groups and SAML Identity Provider (IdP) creation is available on CDP Tenant.

8.  Optional Activation of CDW, CDE and CML data services and provisioning of the required resources e.g. Virtual Service (CDE), Virtual Warehouses (CDW), Virtual Workpace (CML) etc.

9.  The automation in implemented in such a way that it can be retriggered with provision or destroy command as and when required.

10. The code uses Cloudera CDP-TF-Quickstart Terraform based module and pulls the latest version dynamically at runtime.

11. Deployment of Number of CDW Warehouses is determined dynamically, based on number of workshop users.


---


== Usage Documentation for Automation

For more information on how to use this HoL provisioner Docker image, see the main README file:

link:../README.adoc[**Link to Usage Documentation**]


---


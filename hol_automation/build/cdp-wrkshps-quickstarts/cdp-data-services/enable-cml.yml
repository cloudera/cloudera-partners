---
- name: Enable CML data service
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Check and print variable status
      debug:
        msg: "cdp_env_name: {{ cdp_env_name }}, workshop_name: {{ workshop_name }}, workspace_name: {{ workshop_name }}-cml-ws"

    - name: Describe CML Workspace for existence check
      ansible.builtin.command: >
        cdp ml describe-workspace \
        --environment-name "{{ cdp_env_name }}" \
        --workspace-name "{{ workshop_name }}-cml-ws"
      register: ml_describe_workspace
      ignore_errors: true

    - name: Set workspace exists flag
      set_fact:
        workspace_exists: "{{ ml_describe_workspace.rc == 0 }}"

    - name: Skip provisioning if workspace already exists
      debug:
        msg: "Workspace {{ workshop_name }}-cml-ws already exists in environment {{ cdp_env_name }}."
      when: workspace_exists

    - name: Provision CML Workspace if it does not exist
      ansible.builtin.command: >
        cdp ml create-workspace \
        --environment-name "{{ cdp_env_name }}" \
        --workspace-name "{{ workshop_name }}-cml-ws" \
        --use-public-load-balancer \
        --enable-model-metrics \
        --no-disable-tls \
        --enable-monitoring \
        --static-subdomain "{{ workshop_name[0:11] }}-cml" \
        --provision-k8s-request "{\"environmentName\":\"{{cdp_env_name}}\",\"instanceGroups\":[{\"instanceType\":\"m5.2xlarge\",\"rootVolume\":{\"size\":256},\"autoscaling\":{\"minInstances\":1,\"maxInstances\":10,\"enabled\":true}}]}"
      register: ml_provision_workspace
      ignore_errors: true
      when: not workspace_exists

    - name: Pause for 30 seconds after provisioning workspace
      pause:
        seconds: 30
      when: not workspace_exists

    - name: Getting CML Workspace Status until Provisioning Completes
      ansible.builtin.command: >
        cdp ml describe-workspace \
        --environment-name "{{ cdp_env_name }}" \
        --workspace-name "{{ workshop_name }}-cml-ws"
      register: ml_ws_status
      until: ml_ws_status.stdout is defined and ml_ws_status.stdout | from_json | json_query('workspace.instanceStatus') in ["modify:finished", "installation:finished", "installation:failed", "provision:failed", "modify:failed"]
      retries: 150
      delay: 30
      ignore_errors: true

    - name: Print ML Workspace Status
      debug:
        msg: "ML Workspace Status is {{ ml_ws_status.stdout | default('not available') | from_json | json_query('workspace.instanceStatus') }}. If workspace does not already exist and there are no errors in the execution, usually it takes around ~60 minutes to provision."
      when: ml_ws_status.stdout is defined

    - name: Print success message on successful workspace creation
      debug:
        msg: "Successfully provisioned workspace {{ workshop_name }}-cml-ws in environment {{ cdp_env_name }}."
      when: ml_ws_status.stdout is defined and ml_ws_status.stdout | from_json | json_query('workspace.instanceStatus') == "installation:finished"

    - name: Fail task on Workspace Creation Failed
      fail:
        msg: "Workspace Provisioning Got Failed."
      when: ml_ws_status.stdout is defined and ml_ws_status.stdout | from_json | json_query('workspace.instanceStatus') in ["installation:failed", "provision:failed", "modify:failed"]

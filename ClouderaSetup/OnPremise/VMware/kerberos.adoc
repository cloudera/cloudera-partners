= Kerberos Integration with CDP

== Enable Kerberos
Cloudera Manager provides a wizard for integrating your organizationâ€™s Kerberos with your cluster to provide authentication services. Cloudera Manager clusters can be integrated with:

- MIT Kerberos
- Red Hat Identity Management (FreeIPA)
- Microsoft Active Directory

For more information, see *Enable Kerberos Authentication for CDP*.

== Prerequisites
In our lab, we configured RedHat FreeIPA-based Kerberos authentication. We assume that FreeIPA is pre-configured with users and proper authentication settings for Kerberos Authentication.

Before integrating Kerberos with your cluster:
- Configure TLS encryption between Cloudera Manager Server and all Cloudera Manager Agent host systems.
- Ensure administrative access to the FreeIPA Kerberos KDC for creating principals and troubleshooting Kerberos tickets.
- If using Active Directory, ensure pre-configured OU, users, and authentication setup. LDAP users and bind users should be in the same branch/OU.
- Ensure administrative access to the Active Directory KDC for principal creation and troubleshooting Kerberos ticket renewal.

== Verify and Modify `/etc/krb5.conf`
Check and ensure that the `default_ccache_name` property is commented out in `/etc/krb5.conf`.

```bash
[root@ipaserver ~]# sudo vi /etc/krb5.conf
#default_ccache_name = KEYRING:persistent:%{uid}
```

If changes were made, restart the IPA services:

```bash
[root@ipaserver ~]# ipactl restart
```

== Configuring Kerberos in Cloudera Manager
1. Open Cloudera Manager UI.
2. Click *Set up a KDC* on the TLS page.
3. Click *Continue*.
4. Select *RedHat IPA* and check *I have completed all the above steps*.
5. If using Active Directory, select *Active Directory* instead.

== Install Required Packages (If Not Installed)
(Skip if dependencies are already installed.)

```bash
[root@ipaserver ~]# ansible all -m command -a "dnf install -y openldap-clients krb5-workstation krb5-libs"
```

== Enter KDC Information
Provide the following details in the *Enter KDC Information* page:

[options="header"]
|====================
| Component                          | Value
| Kerberos Encryption Types          | aes256-cts-hmac-sha1-96
| Kerberos Security Realm            | CLDRSETUP.LOCAL
| KDC Server Host                    | ipaserver.cldrsetup.local
| KDC Admin Server Host              | ipaserver.cldrsetup.local
| Domain Name(s)                      | cldrsetup.local
| Base DN                             | dc=cldrsetup,dc=local
| AD Suffix (Only for AD Kerberos)    | OU=admin,DC=cldrsetup,DC=local
| AD Delete Accounts on Credential Regeneration | Check (Select)
|====================

== Enable Kerberos Management
1. On the next page, check *Manage `krb5.conf`*.
2. Provide the admin credentials created during FreeIPA setup.
3. Click *Continue*.
4. Enter the Kerberos realm in uppercase.
5. Click *Finish*.

== Validate Kerberos Configuration
```bash
[root@ipaserver ~]# kinit admin@CLDRSETUP.LOCAL
Password for admin@CLDRSETUP.LOCAL: <password>
[root@ipaserver ~]# klist -e
```

== Troubleshooting Keytab Errors
If a keytab error occurs, restart IPA services:

```bash
[root@ipaserver ~]# ipactl restart && ipactl status
```

== Setup Cloudera Management Services
If Cloudera Management Services are not installed or the UI shows missing data:

1. Open Cloudera Manager UI.
2. Click *(+)* in the top-right corner.
3. Select *Add Cloudera Management Service*.
4. Assign roles to `cldr-mngr.cldrsetup.local`.
5. Configure the Report Manager Database:
   - Provide `DBHostname`, `DBNAME`, `DBUser`, and `DBPassword`.
   - Click *Test Connection*.
   - Click *Continue*.
6. Click *Finish*.
7. Verify that Cloudera Management Services are running and the status is visible.

== Verify Cluster Hosts Are Joined to IPA
```bash
[root@ipaserver ~]# rpm -qa | grep ipa-client
ipa-client-4.6.8-5.el7.centos.16.x86_64
ipa-client-common-4.6.8-5.el7.centos.16.noarch
```


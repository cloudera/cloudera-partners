= Configure Cloudera Manager for External Authentication using LDAP

An LDAP-compliant identity/directory service, such as OpenLDAP/FreeIPA, provides different options for enabling Cloudera Manager to look up user accounts and groups in the directory:

- Use a single Distinguished Name (DN) as a base for matching usernames in the directory.
- Search filter options allow searching for users based on broader criteria, such as group or organizational unit (OU) membership.

The LDAP Distinguished Name Pattern property is deprecated. Leave this field empty while configuring authentication using LDAP in Cloudera Manager.

== Steps to Configure LDAP Authentication

. Login to the Cloudera Manager (CM-UI) admin console.
. Navigate to *Administration → Settings*.
. In the filters section, click on *External Authentication*.
. Search for "ldap" and enter values for LDAP authentication as shown below:

[options="header"]
|====
| Component | Value
| Authentication Backend Order | Database then EXTERNAL
| Authorization Backend Order | Database and EXTERNAL
| External Authentication Type | LDAP
| LDAP URL | `ldap://ipaserver.cldrsetup.local:389/`
| LDAP Bind User Distinguished Name | `uid=admin,cn=users,cn=accounts,dc=cldrsetup,dc=local`
| LDAP Bind Password | `<vmware123>` (password for KDC admin, configured earlier)
| Active Directory Domain (For AD Based LDAP) | `<AD DOMAIN>`
| LDAP User Search Filter | `(&(uid={0})(objectClass=person))`
| LDAP User Search Base | `cn=users,cn=accounts,dc=cldrsetup,dc=local`
| LDAP Group Search Filter | `(&(member={1})(objectClass=posixgroup))`
| LDAP Group Search Base | `cn=groups,cn=accounts,dc=cldrsetup,dc=local`
| LDAP DistName Pattern | `uid=admin,cn=users,cn=accounts,dc=cldrsetup,dc=local`
|====

. Click *Save*. Restart the Cloudera Manager Server for the changes to take effect.

== Restart Cloudera Manager Server

[source,bash]
----
[root@cldr-mngr ~]# systemctl restart cloudera-scm-server
[root@cldr-mngr ~]# systemctl status cloudera-scm-server -l
[root@cldr-mngr ~]# sudo tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log
----

Sample log entries after restart:

[source]
----
2024-08-21 03:14:10,007 INFO WebServerImpl:com.cloudera.server.cmf.ExternalAuthenticationHelper: Using LDAP authentication with properties: DN pattern=(uid=admin,cn=users,cn=accounts,dc=cldrsetup,dc=local) user search base=(cn=users,cn=accounts,dc=cldrsetup,dc=local) user search filter=((&(uid={0})(objectClass=person))) group search base=(cn=groups,cn=accounts,dc=cldrsetup,dc=local) group search filter=((&(member={1})(objectClass=posixgroup)))
2024-08-21 03:14:10,009 INFO WebServerImpl:com.cloudera.server.cmf.WebServerImpl: Authenticating against database, then LDAP
----

== Configure LDAP/PAM Group Mapping

. Login again to CM-UI and navigate to *Administration → Users & Roles → LDAP/PAM Groups*.
. Add LDAP/PAM Group mapping with the following values:

[options="header"]
|====
| LDAP/PAM Group | Roles
| `admin` | Full Administrator
|====

. Click on *Test LDAP Connectivity*.
. Provide an LDAP username and password for authentication (e.g., `admin` / `<vmware123>`).
. Click *Test* to verify LDAP configuration.

== Restart Cloudera Manager Server Again

[source,bash]
----
[root@cldr-mngr ~]# systemctl restart cloudera-scm-server
[root@cldr-mngr ~]# systemctl status cloudera-scm-server -l
[root@cldr-mngr ~]# sudo tail -f /var/log/cloudera-scm-server/cloudera-scm-server.log
----

Sample log entries:

[source]
----
2024-03-19 00:56:15,620 INFO pool-7-thread-1:com.cloudera.server.cmf.components.CmServerStateSynchronizer: (30 skipped) Synced up
2024-03-19 00:46:49,935 INFO LDAP login monitor thread.: org.springframework.security.ldap.DefaultSpringSecurityContextSource:  URL 'ldap://ipaserver.cldrsetup.local:389/cn=users,cn=accounts,dc=cldrsetup,dc=local', root DN is 'cn=users,cn=accounts,dc=cldrsetup,dc=local'
2024-03-19 00:56:13,528 INFO LDAP login monitor thread.: org.springframework.ldap.core.support.AbstractContextSource: Property 'password' not set - blank password will be used
2024-03-19 00:56:14,269 INFO CommandPusher-1:com.cloudera.server.cmf.CommandPusherThread: Acquired lease lock on DbCommand:1546344098
2024-03-19 00:56:14,620 INFO pool-7-thread-1:com.cloudera.server.cmf.components.CmServerStateSynchronizer: (30 skipped) Cleaned up
----

== Assign Roles for New Users

Login to Cloudera Manager WebUI and assign roles for new users.
(If using `admin`, skip this step.)


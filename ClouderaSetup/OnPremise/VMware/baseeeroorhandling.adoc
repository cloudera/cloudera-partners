= CDP PvC Base Cluster Error Handling

== Python Configuration
[source,sh]
----
alternatives --set python /usr/bin/python2
----

== SSL Certificate Extraction
[source,sh]
----
openssl s_client -connect cldr-mngr.cldrsetup.local:8443 < /dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > knoxssoAmbari.crt
----

== PostgreSQL Configuration
* If you are using PostgreSQL, turn off Readline support by using the `-n` option (history-passwd).
* Start the Cloudera Management Service when the Reports Manager role is ready. See _Starting the Cloudera Management Service_.

== Ranger Solr and Ranger HDFS Plugins
Ensure that the Ranger Solr and Ranger HDFS plugins are enabled.

== Configuring TLS 1.2 for Reports Manager
. On the Cloudera Manager UI, navigate to _Clusters_ > _Cloudera Management Service_.
. Select the _Configuration_ tab and search for `reportsmanager_db_safety_valve`.
. Override the `headlamp.db.properties` file with the appropriate JDBC URL properties:

[source,properties]
----
com.cloudera.headlamp.orm.hibernate.connection.url=jdbc:postgresql://<DB-HOST>:<DB-PORT>/<DB_NAME>?useSSL=true&trustCertificateKeyStoreUrl=<PATH_TO_TRUSTSTORE_FILE>&trustCertificateKeyStoreType=<TRUSTSTORE_TYPE>&trustCertificateKeyStorePassword=<TRUSTSTORE_PASSWORD>
com.cloudera.headlamp.db.type=postgresql
com.cloudera.headlamp.db.host=<DB-HOST>:<DB-PORT>
com.cloudera.headlamp.db.name=<DB_NAME>
----

== Common Errors and Solutions

=== Cloudera Agent Heartbeat Failure
[source,log]
----
[15/Mar/2024 04:59:00 -0700] 10184 MainThread agent  ERROR Heartbeating to localhost:7182 failed.
...
M2Crypto.SSL.Checker.WrongHost: Peer certificate subjectAltName does not match host, expected localhost, got DNS:pvcbasemaster.cldrsetup.local
----

*Solution:* Change the hostname to DNS name instead of localhost in `/etc/cloudera-scm-agent/config.ini`, then restart all agents:
[source,sh]
----
/opt/cloudera/cm-agent/bin/supervisorctl -c /var/run/cloudera-scm-agent/supervisor/supervisord.conf restart status_server
----

=== Ranger and Atlas Issues
* Due to Kafka and Solr issues, Ranger and Atlas may not start.
* Initialize Solr, create HDFS home directory, and start the service to resolve Solr errors.
* Kafka and Solr depend on Ozone; install them in the correct order.

=== YARN Queue Manager Error
[source,sh]
----
sudo mkdir /var/lib/hadoop-yarn/
sudo chmod +077 /var/lib/hadoop-yarn/
sudo chown yarn:hadoop /var/lib/hadoop-yarn/
----

=== Kafka Metadata Corruption
[source,sh]
----
rm -f /var/local/kafka/data/meta.properties
----

=== HBase Thrift Server Enablement
[source,properties]
----
wal property codec-hbase
----

=== Ozone Errors
* If Ozone fails to start due to missing files, ensure `hdfs_service` is enabled in the Ozone configuration.
* Clean up Ozone directories before redeployment:
[source,sh]
----
rm -rvf /hdfs/*had*oz* /var/lib/had*oz* /etc/had*oz*
----

=== PostgreSQL Connection Limit Exceeded
[source,sh]
----
# Increase max connections in postgresql.conf
max_connections = 1000
----

=== Ranger UI SSL Issue
* Issue caused by incorrect permissions on the `cloudera-scm-server` directory where `root.crt` was stored.

=== Logs and Debugging
[source,sh]
----
tail -f /var/log/ranger/admin/access_log-pvcbasemaster.cldrsetup.local-2024-03-21.log
----

*Ensure `mgmt` service is installed for charts to display properly.*